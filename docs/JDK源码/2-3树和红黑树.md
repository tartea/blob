### 为什么使用树结构

------

从最根本的原因来看，使用树结构就是为了提升整体的效率;插入、删除、查找 (索引)，尤其是索引操作。因为相比于链表，一个平衡树的索引时间复杂度是 O(logn)，而数组的索引时间复杂度是 O(n)。

![image-20211230110147100](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301101141.png)

- 从上图可以看到，使用树结构有效的降低时间复杂度，提升数据索引效率。
- 另外这个标准的树结构，是二叉搜索树(Binary Search Tree)。除此之外树形结构还有：AVL 树、红黑树、2-3 树等

在树的数据结构中，最先有点是二叉查找树，也就是英文缩写 BST 树。在使用数 据插入的过程中，理想情况下它是一个平衡的二叉树，但实际上可能会出现二叉 树都一边倒，让二叉树像列表一样的数据结构。从而树形结构的时间复杂度也从 O(logn)
升级到 O(n)，如下图：

![image-20211230110257073](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301102100.png)

- 二叉搜索树的数据插入过程是，插入节点与当前树节点做比对，小于在左，大于在右。
- 随着数据的插入顺序不同，就会出现完全不同的数据结构。可能是一棵平衡二叉 树，也极有可能退化成链表的树。
- 当树结构退化成链表以后，整个树索引的性能也跟着退化成链表。

**综上呢，如果我们希望在插入数据后又保持树的特点，O(logn)的索引性能，那么就需要在插入时进行节点的调整**

### 2-3树

------

2-3 树是一种非常巧妙的结构，在保持树结构的基础上，它允许在一个节点中可 以有两个元素，等元素数量等于 3 个时候再进行调整。通过这种方式呢，来保证 整个二叉搜索树的平衡性。

#### ![image-20211230110704935](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301107978.png)

- 左侧是二叉搜索树，右侧是 2-3 平衡树，分别插入节点 4、5，观察树形结构变 化。
- 二叉搜索树开始出现偏移，节点一遍倒。
- 2-3 树通过一个节点中存放 2 到 3 个元素，来调整树形结构，保持平衡。所谓的保持平衡就是从根节点，到每一个最底部的自己点，链路长度一致。

**2-3 树已经可以解决平衡问题那么，数据是怎么存放和调整的呢？**

#### 使用

![image-20211230110948349](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301109386.png)

综上我们可以总结出，2-3 树的一些性质：

1. 2-3 树所有子叶节点都在同一层
2. 1 个节点可以有 1 到 2 个数据，如果有三个需要调整树结构
3. 1 个节点 1 个数据时，则有两个子节点
4. 1 个节点 2 个数据时，则有三个子节点，且中间子节点是介于两个节点间的值

#### 数据插入

接下来我们就模拟在二叉搜索树中退化成链表的数据，插入到 2-3 树的变化过 程，数据包括;1、2、3、4、5、6、7，插入过程图如下：

![image-20211230111154945](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301111975.png)

以上，就是整个数据在插入过程中，2-3 树的演化过程，接下来我们具体讲解每 一步的变化;

- α，向节点 1 插入数据 2，此时为了保持平衡，不会新产生分支，只会在一个节点 中存放两个节点。

- β，继续插入数据 3，此时这个节点有三数据，1、2、3，是一个临时区域。

- γ，把三个数据的节点，中间节点拉起来，调整成树形结构。

- δ，继续插入数据 4，为了保持树平衡，会插在节点 3 的右侧。

- ε，继续插入数据 5，插入后 3、4、5 共用 1 个节点，当一个节点上有三个数据时

  候，则需要进行调整。

- ζ，中间节点 4 向上调整，调整后，1 节点在左、3 节点在中间、5 节点在右。

- η ，继续插入数据 6，在保持树平衡的情况下，与节点 5 公用。

- θ ，继续插入数据 7，插入后，节点 7 会与当前的节点 5 6 共用。此时是一个临时存放，需要调整。初步调整后，抽出 6 节点，向上存放，变为 2 4 6 共用一个 节点，这是一个临时状态，还需要继续调整。

- ι，因为根节点有三个数据 2、4、6，则继续需要把中间节点上移，1、3 和 5、7 则分别成二叉落到节点 2、节点 6 上。

> 希腊字母:α(阿尔法)、 β(贝塔)、γ(伽马)、δ(德尔塔)、ε(伊普西隆)、 ζ(截塔)、η(艾塔)、θ(西塔)、ι(约塔)

#### 数据删除

有了上面数据插入的学习，在看数据删除其实就是一个逆向的过程，在删除的主 要包括这样两种情况;

1. 删除了 3-节点，也就是包含两个数据元素的节点，直接删除即可，不会破坏树平 衡。
2. 删除了 2-节点，此时会破坏树平衡，需要将树高缩短或者元素合并，恢复树平 衡。

承接上面的例子，我们把数据再从 7、6、5、4、3、2、1 顺序删除，观察 2-3 树 的结构变化，如下;

![image-20211230120347469](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301203513.png)

- α，删除节点 7，因为节点 7 只有一个数据元素，删除节点 5、6 合并，但此时破 坏了 2-3 树的平衡性，需要缩短树高进行调整。
- β，因为删除节点后，整个树结构不平衡，所以需要缩短树高，调整元素。节点 2、4 合并，节点 1、3 分别插入左侧和中间。
- γ，删除节点 6，这个节点是 3-节点(可以分出 3 个叉的意思)，删除后不会破坏树 平衡，保持不变。
- δ，删除节点 5，此时会破坏树平衡，需要把跟节点 4 下放，与 3 合并。
- ε，删除节点 4，这个节点依旧是 3-节点，所以不需要改变树结构
- ζ，删除节点 3，此时只有 1、2 节点，需要合并。
- η ，删除节点 2，此时节点依旧是 3-节点，所以不需要改变树结构。

**再看一个稍微复杂点2-3树的删除**

![image-20211230120540719](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301205749.png)

上面这张图，就一个稍微复杂点的 2-3 平衡树，树的删除过程主要包括;

1. 删除 4，其实需要将节点 3、5 合并，指向节点 2，保持树平衡。
2. 删除 7，节点 8、9 合并。
3. 删除 14，节点 15 上移，恢复成 3-叉树。

#### 数据索引

相比于插入和删除，索引的过程还是比较简单的，不需要调整数据结果。基本原 则就是;

1. 小于当前节点值，左侧寻找
2. 大于当前节点值，右侧寻找
3. 一直到找到索引值，停止。

![image-20211230120858314](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301208362.png)

### 红黑树

Rudolf Bayer 于1978年发明红黑树，在当时被称为对称二叉 B 树(symmetric binary B-trees)。后来，在 1978 年被 Leo J. Guibas 和 Robert Sedgewick 修
改为如今的红黑树。

红黑树具有良好的效率，它可在近似O(logN) 时间复杂度下完成插入、删除、查 找等操作，因此红黑树在业界也被广泛应用，比如 Java 中的 TreeMap，JDK 1.8 中的 HashMap、C++ STL 中的 map
均是基于红黑树结构实现的。

#### 红黑树规则

1. 根节点是黑色
2. 节点是红黑或者黑色
3. 所有子叶节点都是黑色(叶子是 NIL 节点，即空节点，默认没有画出来)
4. 每个红色节点必须有两个黑色子节点(也同样说明一条链路上不能有链路的红色节点)
5. 黑高，从任一节点到齐每个叶子节点，经过的路径都包含相同数目的黑色节点

#### 为什么既有 2-3 树要有红黑树

首先 2-3 树(读法:二三树)就是一个节点有 1 个或者 2 个元素，而实际上 2-3 树 转红黑树是由概念模型 2-3-4 树转换而来的。-4 叉就是一个节点里有 3 个元素， 这在 2-3 树中会被调整，但是在概念模型中是会被保留的。
虽然 2-3-4 树也是具备 2-3 树同样的平衡树的特性，但是如果直接把这样的模型 用代码实现就会很麻烦，且效率不高，这里的复杂点包括;

1. 2-叉、3-叉、4-叉，三种结构的节点类型，互相转换复杂度较高
2. 3-叉、4-叉，节点在数据比较上需要进行多次，不像 2-叉节点，直接布尔类型比较即可非左即右
3. 代码实现上对每种差异，都需要有额外的代码，规则不够标准化

所以，希望找到一种平衡关系，既保持 2-3 树平衡和 O(logn)的特性，又能在代 码实现上更加方便，那么就诞生了红黑树。

#### 简单 2-3 树转红黑树

2-3树转红黑树，也可以说红黑树是2-3树和2-3-4树的另外一种表现形式，也就 是更利于编码实现的形式

![image-20211230121304276](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301213310.png)

从上图可以看出，2-3-4 树与红黑树的转换关系，包括;

1. 2-叉节点，转换比较简单，只是把原有节点转换为黑色节点

2. 3-叉节点，包括了 2 个元素，先用红色线把两个节点相连，之后拆分出来，最后调

   整高度黑色节点在上

3. 4-叉节点，包括了 3 个元素，分别用红黑线连接，之后拆分出来拉升高度。这个拉

   升过程和 2-3 树调整一致，只是添加了颜色

综上，就是 2-3-4 树的节点转换，总结出来的规则，如下;

1. 将 2-3-4 树，用二叉树的形式表示
2. 3-叉、4-叉节点，使用红色、黑色连线进行连接
3. 另外，3-叉节点有两种情况，导致转换成二叉树，就有左倾和右倾

#### 复杂 2-3 树转红黑树

在简单 2-3 树转换红黑树的过程中，了解到一个基本的转换规则右旋定义，接下来 我们在一个稍微复杂一点的 2-3 树与红黑树的对应关系，如下图;

![image-20211230135227188](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301352222.png)

上图是一个稍微复杂点的 2-3 树，转换为红黑树的过程，是不这样一张图让你对 红黑树更有感觉了，同时它也满足一下条件;

1. 从任意节点到叶子节点，所经过的黑色节点数目相同
2. 黑色节点保持着整体的平衡性，也就是让整个红黑树接近于 O(logn)时间复杂度
3. 其他红黑树的特点也都满足，可以对照红黑树的特性进行比对

> 上面的图在转换的时候，10和11插入的先后顺序不同，也会导致最终形成的树也不同

#### 平衡操作

红黑树是 2-3-4 树的一种概念模型转换而来，在插入节点时通过红色链接相 连，也就是插入红色节点。插入完成后进行调整，以保持树接近平衡。

那么，为了让红黑树达到平衡状态，主要包括染色、↔左右旋转、这些做法其实 都是从 2-3 树演化过来的。接下来我们就分别讲解几种规则的演化过程，以此更 好了解红黑树的平衡操作。

##### 左旋转

把一个向右倾斜的红节点链接(2-3树，3-叉双元素节点)，转化为左 链接。

![image-20211230135547790](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301355822.png)

背景:顺序插入元素，1、2、3，2-3 树保持平衡，红黑树暂时处于右倾斜。 接下来我们分别对比两种树结构的平衡操作;

1. 2-3 树，所有插入的节点都会保持在一个节点上，之后通过调整节点位置，保持平 衡。
2. 红黑树，则需要通过节点的左侧旋转，将元素 2 拉起来，元素 1 和元素 3，分别成 为左右子节点。

红黑树的左旋，只会处理与之对应的 2-3 树节点进行操作，不会整体改变。

##### 右旋转

把一个向左倾斜的红节点连接(2-3树，3-叉双元素节点)，转换为右 连接。

![image-20211230135642778](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301356811.png)

背景:顺序插入元素，3、1、1，2-3 树保持平衡，红黑树暂时处于左倾斜。 接下来我们分别对比两种树结构的平衡操作;

1. 2-3 树，所有插入的节点都会保持在一个节点上，之后通过调整节点位置，保持平 衡。
2. 红黑树，则需要通过节点的右侧旋转，将元素 2 拉起来，元素 1 和元素 3，分别成 为左右子节点。

**你会发现，左旋与右旋是相互对应的，但在 2-3 树中是保持不变的**

##### 左右旋综合运用

![image-20211230135747598](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301357631.png)

以上的例子分别演示了一个元素插入的三种情况，如下;

1. 1、3，插入 0，左侧底部插入，与 2-3 树相比，需要右旋保持平衡

2. 1、3，插入 2，中间位置插入，首先进行左旋调整元素位置，之后进行右旋进行树

   平衡

3. 1、3，插入 5，右侧位置插入，此时正好保持树平衡，不需要调整

#### 染色

在 2-3 树中，插入一个节点，为了保持树平衡是不插入到空位置上的，当插入节 点后元素数量有 3 个后则需要调整中间元素向上，来保持树平衡。与之对应的红 黑树则需要调整颜色，来保证红黑树的平衡规则，具体参考如下;

![image-20211230135833122](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301358155.png)

#### 旋转+染色运用案例

![image-20211230135859254](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301358287.png)

- 首先从左侧开始，是一个按照顺序插入生产出来的红黑树，插入顺序;7、2、 8、1、4、3、5

- α，向目前红黑树插入元素 6，插入后右下角有三个红色节点;3、5、6。
- β，因为右下角满足染色条件，变换后;黑色节点(3、5)、红色节点(4、6)。
- γ，之后看被红色连线链接的节点 7、4、2，最小节点在中间，左旋平衡树结构。
- δ，左旋完成后，红色链接线的 7、4、2 为做倾顺序节点，因此需要做右旋操作。
- ε，左旋、右旋，调整完成后，又满足了染色操作。到此恢复红黑树平衡。

**注意，所有连接红色节点的，都是是红色线。以此与 2-3 树做对应。**

#### 删除操作

根据 2-3-4 树模型的红黑树，在删除的时候基本是按照 2-3 方式进行删除，只不 过在这个过程中需要染色和旋转操作，以保持树平衡。删除过程主要可以分为如 图四种情况，如下;

![image-20211230140045934](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301400972.png)

##### 删除子叶红色节点

红色子叶节点的删除并不会破坏树平衡，也不影响树高，所以直接删除即可，如 下;

![image-20211230140110547](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301401581.png)

##### 删除左侧节点

**被删节点兄弟为黑色&含右子节点**

![image-20211230140136461](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301401497.png)

**被删节点兄弟为黑色&含左子节点**

![image-20211230140153647](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301401681.png)

**被删节点兄弟为黑色&含双子节点(红)**

![image-20211230140211213](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301402250.png)

**被删节点兄弟为黑色&不含子节点**

![image-20211230140231097](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301402132.png)

**被删节点兄弟为黑色&含双黑节点(黑)**

![image-20211230140252533](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301402570.png)

##### 删除右侧节点

**被删节点兄弟为黑色&含左子节点**

![image-20211230140315746](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301403779.png)

**被删节点兄弟为黑色&含右子节点**

![image-20211230140330553](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301403590.png)

**被删节点兄弟为黑色&含双子节点(红)**

![image-20211230140347001](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301403037.png)

**被删节点兄弟为黑色&不含子节点**

![image-20211230140410650](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301404687.png)

**被删节点兄弟为黑色&含双黑节点(黑)**

![image-20211230140425711](https://images-1258301517.cos.ap-nanjing.myqcloud.com/images/202112301404748.png)

